Goal: Create a dedicated Node.js Express app called asknewton-webhooks that exposes two HMAC-verified webhooks for ElevenLabs:

POST /webhooks/eleven/conversation-init

POST /webhooks/eleven/conversation-end

Also include /healthz, /version, and a simple in-memory /events viewer for debugging (with idempotency + size limits).

Project Setup

Create the following files with the exact contents:

package.json

{
  "name": "asknewton-webhooks",
  "version": "1.0.0",
  "type": "module",
  "private": true,
  "scripts": {
    "start": "node server.js",
    "dev": "NODE_ENV=development node server.js",
    "test:init": "bash ./test/init.sh",
    "test:end": "bash ./test/end.sh"
  },
  "dependencies": {
    "express": "^4.19.2"
  }
}


server.js

import express from "express";
import crypto from "crypto";

const app = express();

// --- Config ---
const PORT = process.env.PORT || 3000;
const MAX_EVENTS = 200; // cap in-memory store

// --- Raw body & size limit for HMAC ---
app.use(express.json({
  limit: "1mb",
  verify: (req, _res, buf) => { req.rawBody = buf; }
}));

// --- In-memory event store (for debugging + idempotency) ---
const seenIds = new Set();
const events = []; // [{id, type, ts, path, body}]

function recordEvent({ id, type, path, body }) {
  const ts = new Date().toISOString();
  events.unshift({ id, type, ts, path, body });
  if (events.length > MAX_EVENTS) events.pop();
}

// --- HMAC helpers ---
const CANDIDATE_HEADERS = [
  "x-elevenlabs-signature",
  "x-signature",
  "x-webhook-signature",
  "x-hub-signature"
];

function getSignatureHeader(req) {
  return CANDIDATE_HEADERS.map(h => req.get(h)).find(Boolean) || "";
}

function verifyHmac(req, secret) {
  const sigHeader = getSignatureHeader(req);
  const computed = crypto
    .createHmac("sha256", secret)
    .update(req.rawBody || Buffer.from(""))
    .digest("hex");

  try {
    return crypto.timingSafeEqual(Buffer.from(computed), Buffer.from(sigHeader));
  } catch {
    return false;
  }
}

function guard(secretEnvKey) {
  return (req, res, next) => {
    const secret = process.env[secretEnvKey];
    if (!secret) {
      return res.status(500).json({ ok: false, error: `${secretEnvKey} missing` });
    }
    if (!verifyHmac(req, secret)) {
      return res.status(401).json({ ok: false, error: "Invalid signature" });
    }
    next();
  };
}

// --- Idempotency helper ---
// If payload contains `id` or `event_id`, skip duplicates
function idempotency(req, res, next) {
  const id = req.body?.id || req.body?.event_id;
  if (!id) return next();
  if (seenIds.has(id)) {
    return res.json({ ok: true, duplicate: true });
  }
  seenIds.add(id);
  next();
}

// --- Webhooks ---
app.post(
  "/webhooks/eleven/conversation-init",
  guard("ELEVEN_INIT_SECRET"),
  idempotency,
  (req, res) => {
    // Optional: enforce a simple shape
    const id = req.body?.id || req.body?.event_id || `init-${Date.now()}`;
    recordEvent({
      id,
      type: "conversation-init",
      path: req.path,
      body: req.body
    });
    // TODO: kick off your own async processing if needed
    res.json({ ok: true });
  }
);

app.post(
  "/webhooks/eleven/conversation-end",
  guard("ELEVEN_END_SECRET"),
  idempotency,
  (req, res) => {
    const id = req.body?.id || req.body?.event_id || `end-${Date.now()}`;
    recordEvent({
      id,
      type: "conversation-end",
      path: req.path,
      body: req.body
    });
    res.json({ ok: true });
  }
);

// --- Health & diagnostics ---
app.get("/healthz", (_req, res) => res.json({ ok: true, service: "asknewton-webhooks" }));
app.get("/version", (_req, res) => res.json({ version: "1.0.0" }));

// VERY basic read-only events viewer (trimmed bodies for safety)
app.get("/events", (_req, res) => {
  const trimmed = events.map(e => ({
    id: e.id,
    type: e.type,
    ts: e.ts,
    path: e.path,
    // Avoid dumping large/PII-heavy payloads:
    body_preview: JSON.stringify(e.body ?? {}).slice(0, 600)
  }));
  res.json({ count: trimmed.length, items: trimmed });
});

app.listen(PORT, () => {
  console.log(`asknewton-webhooks listening on :${PORT}`);
});


test/init.sh

#!/usr/bin/env bash
set -euo pipefail

BODY='{"ping":"init","id":"test-init-1"}'
: "${ELEVEN_INIT_SECRET:?Set ELEVEN_INIT_SECRET in your shell or Replit Secrets}"

SIG=$(printf "%s" "$BODY" | openssl dgst -sha256 -hmac "$ELEVEN_INIT_SECRET" -hex | awk '{print $2}')

curl -sS -X POST "$REPL_HOST/webhooks/eleven/conversation-init" \
  -H "Content-Type: application/json" \
  -H "x-elevenlabs-signature: $SIG" \
  -d "$BODY" | jq .


test/end.sh

#!/usr/bin/env bash
set -euo pipefail

BODY='{"ping":"end","id":"test-end-1"}'
: "${ELEVEN_END_SECRET:?Set ELEVEN_END_SECRET in your shell or Replit Secrets}"

SIG=$(printf "%s" "$BODY" | openssl dgst -sha256 -hmac "$ELEVEN_END_SECRET" -hex | awk '{print $2}')

curl -sS -X POST "$REPL_HOST/webhooks/eleven/conversation-end" \
  -H "Content-Type: application/json" \
  -H "x-elevenlabs-signature: $SIG" \
  -d "$BODY" | jq .


README.md

# AskNewton Webhooks (ElevenLabs)

Minimal Express server with HMAC verification for ElevenLabs webhooks.

## Endpoints
- `POST /webhooks/eleven/conversation-init`
- `POST /webhooks/eleven/conversation-end`
- `GET  /healthz` (liveness)
- `GET  /version` (build info)
- `GET  /events` (recent deliveries, trimmed)

## Env / Secrets (set in Replit → Secrets)
- `ELEVEN_INIT_SECRET` – HMAC secret for conversation-init
- `ELEVEN_END_SECRET` – HMAC secret for conversation-end
- `PORT` (optional, default 3000)

## Run
```bash
npm install
npm start

Test (curl)

Set your host (Replit URL), then run tests:

export REPL_HOST="https://<your-repl>.replit.app"
# In Replit Shell, secrets are already in env
npm run test:init
npm run test:end


Or run manual one-liners:

BODY='{"ping":"init"}'
SIG=$(printf "$BODY" | openssl dgst -sha256 -hmac "$ELEVEN_INIT_SECRET" -hex | awk '{print $2}')
curl -X POST "$REPL_HOST/webhooks/eleven/conversation-init" -H "Content-Type: application/json" -H "x-elevenlabs-signature: $SIG" -d "$BODY"

ElevenLabs Console

Create two HMAC webhooks:

https://<your-repl>.replit.app/webhooks/eleven/conversation-init → secret = ELEVEN_INIT_SECRET

https://<your-repl>.replit.app/webhooks/eleven/conversation-end → secret = ELEVEN_END_SECRET

Use Send Test Event to verify 200 OK responses.


**Make test scripts executable**
```bash
chmod +x test/init.sh
chmod +x test/end.sh

Secrets to Add (Replit → Secrets)

ELEVEN_INIT_SECRET = <paste ElevenLabs generated secret for init>

ELEVEN_END_SECRET = <paste ElevenLabs generated secret for end>

(optional) PORT = 3000

Run & Verify

npm install

npm start

Open: GET /healthz → should return { ok: true, service: "asknewton-webhooks" }

Set REPL_HOST="https://<your-repl>.replit.app" and run:

npm run test:init

npm run test:end

Check GET /events to see recent deliveries (trimmed).

Notes

Uses raw body capture to compute HMAC exactly as sent.

Constant-time compare via crypto.timingSafeEqual.

Idempotency: if payload includes id or event_id, duplicates are auto-ignored.

In-memory store is for debugging only—swap for a DB if you need persistence.