Goal: Stand up a secure ElevenLabs webhook handler with Slack alerts.

package.json
{
  "name": "asknewton-webhooks",
  "version": "1.1.0",
  "type": "module",
  "private": true,
  "scripts": {
    "start": "node server.js",
    "dev": "NODE_ENV=development node server.js"
  },
  "dependencies": {
    "express": "^4.19.2",
    "node-fetch": "^3.3.2"
  }
}

server.js
import express from "express";
import crypto from "crypto";
import fetch from "node-fetch";

const app = express();
const PORT = process.env.PORT || 3000;
const MAX_EVENTS = 200; // cap in-memory store

// --- Slack Alert ---
async function sendSlackAlert(message) {
  const webhook = process.env.SLACK_WEBHOOK_URL;
  if (!webhook) return; // silently skip if not configured
  try {
    await fetch(webhook, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ text: message })
    });
  } catch (err) {
    console.error("Slack alert failed:", err.message);
  }
}

// --- Raw body for HMAC ---
app.use(express.json({
  limit: "1mb",
  verify: (req, _res, buf) => { req.rawBody = buf; }
}));

// --- In-memory event store ---
const seenIds = new Set();
const events = [];

function recordEvent({ id, type, path, body }) {
  const ts = new Date().toISOString();
  events.unshift({ id, type, ts, path, body });
  if (events.length > MAX_EVENTS) events.pop();
}

// --- HMAC verification ---
const CANDIDATE_HEADERS = [
  "x-elevenlabs-signature",
  "x-signature",
  "x-webhook-signature",
  "x-hub-signature"
];

function getSignatureHeader(req) {
  return CANDIDATE_HEADERS.map(h => req.get(h)).find(Boolean) || "";
}

function verifyHmac(req, secret) {
  const sigHeader = getSignatureHeader(req);
  const computed = crypto
    .createHmac("sha256", secret)
    .update(req.rawBody || Buffer.from(""))
    .digest("hex");

  try {
    return crypto.timingSafeEqual(Buffer.from(computed), Buffer.from(sigHeader));
  } catch {
    return false;
  }
}

function guard(secretEnvKey) {
  return (req, res, next) => {
    const secret = process.env[secretEnvKey];
    if (!secret) {
      sendSlackAlert(`ğŸš¨ Missing secret: ${secretEnvKey}`);
      return res.status(500).json({ ok: false, error: `${secretEnvKey} missing` });
    }
    if (!verifyHmac(req, secret)) {
      sendSlackAlert(`âš ï¸ Invalid signature on ${req.path}`);
      return res.status(401).json({ ok: false, error: "Invalid signature" });
    }
    next();
  };
}

// --- Idempotency middleware ---
function idempotency(req, res, next) {
  const id = req.body?.id || req.body?.event_id;
  if (!id) return next();
  if (seenIds.has(id)) {
    return res.json({ ok: true, duplicate: true });
  }
  seenIds.add(id);
  next();
}

// --- Webhook routes ---
app.post(
  "/webhooks/eleven/conversation-init",
  guard("ELEVEN_INIT_SECRET"),
  idempotency,
  (req, res) => {
    const id = req.body?.id || req.body?.event_id || `init-${Date.now()}`;
    recordEvent({ id, type: "conversation-init", path: req.path, body: req.body });
    res.json({ ok: true });
  }
);

app.post(
  "/webhooks/eleven/conversation-end",
  guard("ELEVEN_END_SECRET"),
  idempotency,
  (req, res) => {
    const id = req.body?.id || req.body?.event_id || `end-${Date.now()}`;
    recordEvent({ id, type: "conversation-end", path: req.path, body: req.body });
    res.json({ ok: true });
  }
);

// --- Health + diagnostics ---
app.get("/healthz", (_req, res) => res.json({ ok: true, service: "asknewton-webhooks" }));
app.get("/version", (_req, res) => res.json({ version: "1.1.0" }));
app.get("/events", (_req, res) => {
  const trimmed = events.map(e => ({
    id: e.id,
    type: e.type,
    ts: e.ts,
    path: e.path,
    body_preview: JSON.stringify(e.body).slice(0, 600)
  }));
  res.json({ count: trimmed.length, items: trimmed });
});

// --- Error handler ---
app.use((err, req, res, _next) => {
  console.error("Unhandled error:", err);
  sendSlackAlert(`ğŸ”¥ Error on ${req.path}: ${err.message}`);
  res.status(500).json({ ok: false, error: "Server error" });
});

app.listen(PORT, () => {
  console.log(`asknewton-webhooks listening on :${PORT}`);
});

âœ… Required Secrets (Replit â†’ Secrets)
ELEVEN_INIT_SECRET = <ElevenLabs secret for init>
ELEVEN_END_SECRET  = <ElevenLabs secret for end>
SLACK_WEBHOOK_URL  = <your Slack incoming webhook>
PORT = 3000   # optional

ğŸ” Verify

GET /healthz â†’ { ok: true, service: "asknewton-webhooks" }

GET /version â†’ version info

GET /events â†’ recent deliveries

Run Send Test Event in ElevenLabs â†’ should return 200 OK, event visible in /events, and Slack alerts appear for any invalid/missing signature.